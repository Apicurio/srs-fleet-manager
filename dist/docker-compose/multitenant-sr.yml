version: '3'


volumes:
  multitenant-sr-db:

services:

  multitenant-sr-db:
    ports:
      - '5432:5432'
    image: 'postgres:14'
    environment:
      POSTGRES_DB: multitenantsrdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - 'multitenant-sr-db:/var/lib/postgresql/data'

  tenant-manager:
    depends_on:
      - multitenant-sr-db
    image: 'quay.io/apicurio/apicurio-registry-tenant-manager-api:${TENANT_MANAGER_VERSION}'
    ports:
      - "8585:8585"
    environment:
      DATASOURCE_URL: 'jdbc:postgresql://multitenant-sr-db:5432/multitenantsrdb'
      DATASOURCE_USERNAME: 'postgres'
      DATASOURCE_PASSWORD: 'postgres'
      REGISTRY_ROUTE_URL: 'http://registry-app:8080'

  fleet-manager:
    depends_on:
      - multitenant-sr-db
    image: 'quay.io/apicurio/apicurio-registry-fleet-manager:${FLEET_MANAGER_VERSION}'
    ports:
      - '8081:8080'
    environment:
      USE_LOCAL_AMS: 'true'
      SERVICE_API_DATASOURCE_URL: 'jdbc:postgresql://multitenant-sr-db:5432/multitenantsrdb'
      SERVICE_API_DATASOURCE_USERNAME: 'postgres'
      SERVICE_API_DATASOURCE_PASSWORD: 'postgres'
      QUARKUS_FLYWAY_MIGRATE_AT_START: 'true'
      REGISTRY_QUOTA_PLANS_CONFIG_FILE: '/config/quota-plans.yaml'
      REGISTRY_DEPLOYMENTS_CONFIG_FILE: '/config/registry-deployments.yaml'
    volumes:
      - ./config/:/config


  registry-app:
    depends_on:
      - multitenant-sr-db
    image: 'quay.io/apicurio/apicurio-registry-sql:${REGISTRY_VERSION}'
    ports:
      - "8080:8080"
    environment:
      REGISTRY_ENABLE_MULTITENANCY: 'true'
      REGISTRY_DATASOURCE_URL: 'jdbc:postgresql://multitenant-sr-db:5432/multitenantsrdb'
      REGISTRY_DATASOURCE_USERNAME: 'postgres'
      REGISTRY_DATASOURCE_PASSWORD: 'postgres'
      TENANT_MANAGER_AUTH_ENABLED: 'false'
      TENANT_MANAGER_URL: 'http://tenant-manager:8585'

