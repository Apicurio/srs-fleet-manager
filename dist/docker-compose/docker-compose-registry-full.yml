version: '3'

volumes:
  postgre_apicurio:

services:
  tenant-manager:
    image: 'apicurio-registry-tenant-manager-api:${TENANT_MANAGER_VERSION}'
    ports:
      - 8081:8080
    environment:
      DATASOURCE_URL: ${APICURIO_DB_CONNECTION_URL}
      DATASOURCE_USERNAME: ${APICURIO_DB_USER_NAME}
      DATASOURCE_PASSWORD: ${APICURIO_DB_PASSWORD
    depends_on:
      - postgres
      - registry-app
  registry-app:
    image: 'apicurio/apicurio-registry-sql:${REGISTRY_VERSION}'
    ports:
      - 8080:8080
    environment:
      AUTHZ_ENABLED: ${AUTHZ_ENABLED}
      AUTH_ENABLED: ${AUTH_ENABLED}
      KEYCLOAK_URL: ${KEYCLOAK_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM}
      KEYCLOAK_API_CLIENT_ID: ${KEYCLOAK_API_CLIENT_ID}
      KEYCLOAK_UI_CLIENT_ID: ${KEYCLOAK_UI_CLIENT_ID}
      REGISTRY_DATASOURCE_URL: ${APICURIO_DB_CONNECTION_URL}
      REGISTRY_DATASOURCE_USERNAME: ${APICURIO_DB_USER_NAME}
      REGISTRY_DATASOURCE_PASSWORD: ${APICURIO_DB_PASSWORD}

  apicurio-sr-fleet-manager:
    image: 'apicurio/srs-fleet-manager:${FLEET_MANAGER_VERSION}'
    depends_on:
      - apicurio-db
    ports:
      - '8082:8080'
    environment:
      JAVA_TOOL_OPTIONS: '-Djava.net.preferIPv4Stack=true'

      SERVICE_API_DATASOURCE_URL: ${APICURIO_DB_CONNECTION_URL}
      SERVICE_API_DATASOURCE_USERNAME: ${APICURIO_DB_USER_NAME}
      SERVICE_API_DATASOURCE_PASSWORD: ${APICURIO_DB_PASSWORD}

      AUTH_ENABLED: ${AUTH_ENABLED}
      KEYCLOAK_URL: ${KEYCLOAK_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM}
      ORGANIZATION_ID_CLAIM: ${ORGANIZATION_ID_CLAIM}
      DEFAULT_ORG: ${DEFAULT_ORG}
